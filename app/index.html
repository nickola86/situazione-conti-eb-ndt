<!doctype html>
<html>
  <head>
    <!--<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=1">-->
    <title>Lista Movimenti</title>
    <style>
	  *{padding:0;border:0;margin:0; font-family:sans-serif}
	  body{padding:10px;}
	  td,th{margin:0px;border-bottom: 1px solid #ccc;padding: 5px 10px 5px 5px;}
	  th{background-color:#ffffaa}
	  select{margin:10px 0px 30px 0px;}
	  li{padding:left:30px;list-style-type:none}
	  button,select{font-size:1.2em;padding:10px 20px 10px 20px;border:1px solid #aaa}
	  .microfono{
		background-image:url('mic.png');
		background-size:100%;
		height:150px;
		width:150px;
		background-color:transparent;
		padding:0;
		margin:0;
		border:0px;
		border-radius:150px;
		box-sizing:border-box;
	  }
	  .microfono:active{
		border:10px solid white;
		opacity:0.5;
	  }
	  input[type=text]{
		font-size:1em;
		font-style:italic;
		color:#999;
		border-radius:40px;
		height:40px;
		width:100%;
		border:1px solid #ccc;
		display:inline-block;
		padding-left:1em;
		box-sizing:border-box;
		margin-bottom:0.5em;	  
	  }
	  input[type=text].error{
		color:red;
	  }
	  #filtraMovimenti{
		background-image:url('data:image/png;base64,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');
		background-size:40px;
		background-position:right;
		background-repeat:no-repeat;
	  }
    </style>
  </head>
  <body>
	<!--<select id="listUsers"></select>-->
	<!--<button type="button" onclick="refresh()">Aggiorna</button>-->
	<button type="button" ontouchstart="acqStart()" onmousedown="acqStart()" onmouseup="acqStop()" ontouchend="acqStop()" class="microfono"></button>
	<br/><br/>
	<input type="text" id="transcript" onkeyup="submitManuale(event)" placeholder="es: data 11 febbraio 2019 importo 11 euro 40 centesimi descrizione pizzeria grotta azzurra"/>
	<br/><br/>
	<div id="displaydataMovimenti" style="display:none">
		<b>Lista Movimenti</b><br/>
		<!-- Totaloni...
		<ul>
			<li><b style="white-space:nowrap" >Tempo totale di attività : </b> <span style="white-space:nowrap" id="totActive"></span></li>
			<li><b style="white-space:nowrap" >Tempo totale di inattività : </b> <span style="white-space:nowrap" id="totInactive"></span></li>
			<li><b style="white-space:nowrap" >Tempo dall'ultimo evento di <span id="lastEventType"></span> : </b> <span style="white-space:nowrap" id="lastEventElapsed"></span></li>
		<ul>
		<br/>
		-->
		<br/>
		<div id="chart_div" style="width: 560px; height: 300px;display:inline-block;"></div>
		<div id="piechart" style="width: 400px; height: 300px;display:inline-block;"></div>
		<br/>
		<table>
			<thead>
				<th colspan="5" style="background-color: transparent; border:0; margin:0; padding:0;">
					<input type="text" id="filtraMovimenti" onkeyup="filtraMovimenti()" placeholder="Cerca nella tabella dei movimenti..."/>
				</th>
			</thead>
			<thead>
				<th>Data</th>
				<th>Descrizione</th>
				<th>Tipo operazione</th>
				<th>Importo</th>
				<th>Utente</th>
			</thead>
			<tbody id="listMovimenti">
				<td></td><td></td><td></td><td></td><td></td>
			</tbody>
		</table>
	</div>
	<br/><br/>
	<div id="displaydataRimborsi" style="display:none">
		<b>Lista Rimborsi</b><br/>
		<table>
			<thead>
				<th>Data</th>
				<th>Descrizione</th>
				<th>Importo</th>
				<th>Dare/Avere</th>
			</thead>
			<tbody id="listRimborsi">
				<td></td><td></td><td></td><td></td>
			</tbody>
		</table>
	</div>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script>
		var recognition = null;
		$(document).ready(function(){		
			refreshMovimenti();
			refreshRimborsi();
		});
		function refreshMovimenti(){
			$.get("/api/movimenti").then(refreshMovimentiCallback);
		}
		function refreshMovimentiCallback(data) {
			
			if(!data) return;
			
			var users = [];
			$("#listMovimenti").html("");
			var totActive = 0;
			var totInactive = 0;
			var i = 0;
			for(i = 0; i < data.length ; i++){
				var $tr = $("<tr/>");
				var $td = $("<td style='white-space:nowrap'/>");
				$td.text(data[i].data);
				$tr.append($td);
				$td = $("<td/>");
				$td.text(data[i].descrizione);
				$tr.append($td);
				$td = $("<td/>");
				$td.text(data[i].tipoOperazione);
				$tr.append($td);
				$td = $("<td/>");
				$td.text(formatImporto(data[i].importo));
				$tr.append($td);
				$td = $("<td/>");
				$td.text(data[i].utente.nome);
				$tr.append($td);
				$("#listMovimenti").append($tr);
				//Conti
				if(!users[data[i].idUtente]) users[data[i].idUtente] = data[i].utente;
				users[data[i].idUtente].totaleUscite = (users[data[i].idUtente].totaleUscite || 0) + data[i].importo;
			}
			$("#displaydataMovimenti").show();
			try{drawChart(users);}catch(e){}
			try{drawVisualization(data);}catch(e){}
		}
		function refreshRimborsi(){
			$.get("/api/rimborsi").then(function(data){
				var users = [];
				$("#listRimborsi").html("");
				var i = 0;
				for(i = 0; i < data.length ; i++){
					var $tr = $("<tr/>");
					var $td = $("<td style='white-space:nowrap'/>");
					$td.text(data[i].data);
					$tr.append($td);
					$td = $("<td/>");
					$td.text(data[i].descrizione);
					$tr.append($td);
					$td = $("<td/>");
					$td.text(formatImporto(data[i].importo));
					$tr.append($td);
					$td = $("<td/>");
					$td.text(data[i].utenteBeneficiario.nome + " deve rendere a " + data[i].utenteOrdinante.nome);
					$tr.append($td);
					$("#listRimborsi").append($tr);
				}
				$("#displaydataRimborsi").show();
			});
		}
		function utcToLocalDateTime(date){
			var d = new Date(date);
			mm = '' + (d.getMonth() + 1),
			dd = '' + d.getDate(),
			yyyy = d.getFullYear();
			hh24 = '' + d.getHours();
			mi = '' + d.getMinutes();
			ss = '' + d.getSeconds();
			if (mm.length < 2) mm = '0' + mm;
			if (dd.length < 2) dd = '0' + dd;
			if (hh24.length < 2) hh24 = '0' + hh24;
			if (mi.length < 2) mi = '0' + mi;
			if (ss.length < 2) ss = '0' + ss;
			return [dd,mm,yyyy].join('/') + " " + [hh24,mi,ss].join(':');
		}
		function utcToLocalTime(date){
			var d = new Date(date);
			mm = '' + (d.getMonth() + 1),
			dd = '' + d.getDate(),
			yyyy = d.getFullYear();
			hh24 = '' + d.getHours();
			mi = '' + d.getMinutes();
			ss = '' + d.getSeconds();
			if (mm.length < 2) mm = '0' + mm;
			if (dd.length < 2) dd = '0' + dd;
			if (hh24.length < 2) hh24 = '0' + hh24;
			if (mi.length < 2) mi = '0' + mi;
			if (ss.length < 2) ss = '0' + ss;
			return [hh24,mi,ss].join(':');
		}
		function utcToLocalDate(date){
			var d = new Date(date);
			mm = '' + (d.getMonth() + 1),
			dd = '' + d.getDate(),
			yyyy = d.getFullYear();
			hh24 = '' + d.getHours();
			mi = '' + d.getMinutes();
			ss = '' + d.getSeconds();
			if (mm.length < 2) mm = '0' + mm;
			if (dd.length < 2) dd = '0' + dd;
			if (hh24.length < 2) hh24 = '0' + hh24;
			if (mi.length < 2) mi = '0' + mi;
			if (ss.length < 2) ss = '0' + ss;
			return [dd,mm,yyyy].join('/');
		}
		function elapsedToHHMMSS(elapsed){
			var d = new Date(elapsed);
			hh24 = '' + (d.getHours()-1);
			mi = '' + d.getMinutes();
			ss = '' + d.getSeconds();
			if (hh24.length < 2) hh24 = '0' + hh24;
			if (mi.length < 2) mi = '0' + mi;
			if (ss.length < 2) ss = '0' + ss;
			return [hh24,mi,ss].join(':');
		}
		function notify(message) {
		  if (Notification.permission !== "granted")
			Notification.requestPermission().then(function(){notify(message)});
		  else {
			var notification = new Notification('Controllo timbrature', {
			  icon: 'https://cdn.iconscout.com/icon/free/png-64/clock-1960-1119646.png',
			  body: message
			});

			notification.onclick = function () {};

		  }

		}
		function formatImporto(v){return v ? (""+v.toFixed(2)).replace(".",",")+" €" : "0,00 €"}
	</script>
	<script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(()=>{
		refreshMovimenti();
		window.SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
		if ('SpeechRecognition' in window) {
		    recognition = new window.SpeechRecognition();
			recognition.lang = "it-IT";
			recognition.onresult = (event) => {
			  const speechToText = event.results[0][0].transcript;
			  uploadNuovoMovimento(speechToText);
			}
		}
	  });
	  
	  function submitManuale(e){
		document.getElementById("transcript").removeAttribute("class");
		if (e.keyCode == 13) uploadNuovoMovimento(document.getElementById("transcript").value);
	  }
	  
	  function getCurrentPortafoglio(){return 1}
	  function getCurrentUtente(){return 1}
	  
	  function uploadNuovoMovimento(speechToText){
		var parsed = parseMovimento(speechToText);
		if(parsed.error){
			document.getElementById("transcript").value=parsed.error;
			document.getElementById("transcript").setAttribute("class","error");
		}else{
			document.getElementById("transcript").removeAttribute("class");
			document.getElementById("transcript").value=speechToText;
			if(!parsed.data) parsed.data = new Date();
			if(!parsed.idPortafoglio) parsed.idPortafoglio = getCurrentPortafoglio();
			if(!parsed.idUtente) parsed.idUtente = getCurrentUtente();
			$.post("/api/movimenti/new",parsed).then(refreshMovimentiCallback);
		}
	  }
	  
	  function acqStart(){
		recognition.start();
	  }
	  function acqStop(){
		recognition.stop();
	  }

      function drawChart(users) {
		if(!users) return;
	    var datiGrafico = [['Utente', 'Spesa']];
		datiGrafico = datiGrafico.concat(users.map(e=>{return [e.nome,e.totaleUscite];}));
		datiGrafico = datiGrafico.filter(Boolean);
        var data = google.visualization.arrayToDataTable(datiGrafico);

        var options = {
          title: 'Ripartizione totale spese',
		  colors: ['#FF6600','#7030A0']
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart'));

        chart.draw(data, options);
      }
	  function drawVisualization(movimenti) {
        // Some raw data (not necessarily accurate)
        var datiGrafico = [['Month','Totale'],['Gennaio'],['Febbraio'],['Marzo'	],['Aprile'	],['Maggio'	],['Giugno'	],['Luglio'	],['Agosto'	],['Settembre'],['Ottobre'],['Novembre'],['Dicembre']];
		var datiUtenti = [];
		var utenti = [];
		//Scorro i movimenti
		for(var i = 0; i<movimenti.length; i++){
			var j = parseInt(movimenti[i].data.substring(3,5));
			datiGrafico[j][1] = (datiGrafico[j][1] || 0) + movimenti[i].importo;			
			var k = utenti[movimenti[i].idUtente] || 1+utenti.filter(Boolean).length;
			utenti[movimenti[i].idUtente] = k;
			datiGrafico[j][k+1] = (datiGrafico[j][k+1]||0) + movimenti[i].importo; 
			datiGrafico[0][k+1] = movimenti[i].utente.nome;
		}
		
		datiGrafico = datiGrafico.map(e=>{
			for(var i = 1 ; i <= utenti.filter(Boolean).length +1 ; i++){
				e[i] = e[i] || 0;
			}
			return e
		});
		
		var data = google.visualization.arrayToDataTable(datiGrafico);

        var options = {
          title : 'Ripartizione mensile spese',
          vAxis: {title: 'Euro'},
          hAxis: {title: 'Mesi'},
          seriesType: 'bars',
          series: {0: {type: 'line'}},
		  colors: ['#3399FF','#FF6600','#7030A0']
        };

        var chart = new google.visualization.ComboChart(document.getElementById('chart_div'));
        chart.draw(data, options);
      }
	  function filtraMovimenti() {
		  var input, filter, table, tr, td, i, j, txtValue;
		  input = document.getElementById("filtraMovimenti");
		  filter = input.value.toUpperCase();
		  table = document.getElementById("listMovimenti");
		  tr = table.getElementsByTagName("tr");
		  for (i = 0; i < tr.length; i++) {
			td = tr[i].getElementsByTagName("td");
			for (j = 0; j < td.length; j++){
				if (td[j]) {
				  txtValue = td[j].textContent || td[j].innerText;
				  if (txtValue.toUpperCase().indexOf(filter) > -1) {
					tr[i].style.display = "";
					break;
				  } else {
					tr[i].style.display = "none";
				  }
				}
			}
		  }
		}
		function parseMovimento(str){
			str = str.toLowerCase();
			var s = str.split(' ');	
			
			//recupero gli indici
			var i_data = s.indexOf("data");
			var i_importo = s.indexOf("importo");
			var i_descrizione = s.indexOf("descrizione");

			//Inizio le validazioni primarie
			var errMsg = "";
			if(!errMsg && i_importo<0) errMsg += "ParseException: importo non presente\n";
			if(!errMsg && i_descrizione<0) errMsg += "ParseException: descrizione non presente\n";
			
			//recupero i valori in funzione degli indici
			var data = s.slice(i_data+1,i_importo)
			var importo = s.slice(i_importo+1,i_descrizione)
			var descrizione = s.slice(i_descrizione+1,s.length)

			//Inizio le validazioni secondarie
			if(!errMsg && data.length!= 0 && data.length!= 3) errMsg += "ParseException: data deve essere un array di 3 elementi\n";
			if(!errMsg && importo[0] && importo[0].indexOf("€")<0){
				if(!errMsg && importo.length!= 2 && importo.length!= 4) errMsg += "ParseException: importo deve essere un array di 2 elementi oppure di 4 elementi\n";
				if(!errMsg && importo.length==2 && importo[1]!="euro") errMsg += "ParseException: importo non contiene la keyword euro\n";
				if(!errMsg && importo.length==4 && importo[1]!="euro") errMsg += "ParseException: importo non contiene la keyword euro\n";
				if(!errMsg && importo.length==4 && importo[3]!="centesimi" && importo[3]!="centesimo") errMsg += "ParseException: importo non contiene la keyword centesimi\n";		
			}
			
			if(!errMsg && descrizione.length<1) errMsg += "ParseException: descrizione deve essere un array di almeno un elemento\n";

			if(errMsg) {
				//Se ci sono errori esci
				console.log(errMsg);
				return {"error":errMsg};
			}else{
				//Se non ci sono errori....
				
				//decodifica della data
				var mesi = ['gennaio','febbraio','marzo','aprile','maggio','giugno','luglio','agosto','settembre','ottobre','novembre','dicembre']
				var mese = mesi.indexOf(data[1]);
				//faccio il parse della data solo se l'indice data è presente altrimenti lascio non inizializzata
				var pData = i_data >= 0 ? new Date(data[2],mese,data[0]) : undefined;
				
				//decodifica dell importo
				var pImporto = 0;
				if(importo[0].indexOf("€")<0){
					pImporto = parseInt(importo[0] || 0) + parseInt(importo[2] || 0) / 100;
				}else{
					importo[0] = importo[0].slice(importo[0].indexOf("€")+1);
					importo[0] = importo[0].replace(",",".");
					pImporto = parseFloat(importo[0]);
				}
				
				//decodifica della descrizione
				var pDescrizione = descrizione.join(' ');
				
				//Fine
				return {"data":pData,"importo":pImporto,"valuta":"€","descrizione":pDescrizione};
			}	
		}
    </script>
  </body>
</html>
