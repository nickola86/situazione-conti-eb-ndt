<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=1">
    <title>Lista Movimenti</title>
    <style>
	  *{padding:0;border:0;margin:0; font-family:sans-serif}
	  body{padding:10px;}
	  td,th{margin:0px;border-bottom: 1px solid #ccc;padding: 5px 10px 5px 5px;}
	  th{background-color:#ffffaa}
	  select{margin:10px 0px 30px 0px;}
	  li{padding:left:30px;list-style-type:none}
	  button,select{font-size:1.2em;padding:10px 20px 10px 20px;border:1px solid #aaa}
	  #filtraMovimenti{
		font-size:1em;
		font-style:italic;
		color:#999;
		border-radius:40px;
		height:40px;
		width:100%;
		border:1px solid #ccc;
		display:inline-block;
		padding-left:1em;
		box-sizing:border-box;
		margin-bottom:0.5em;
	  }
    </style>
  </head>
  <body>
	<!--<select id="listUsers"></select>-->
	<!--<button type="button" onclick="refresh()">Aggiorna</button>-->
	<div id="displaydataMovimenti" style="display:none">
		<b>Lista Movimenti</b><br/>
		<!-- Totaloni...
		<ul>
			<li><b style="white-space:nowrap" >Tempo totale di attività : </b> <span style="white-space:nowrap" id="totActive"></span></li>
			<li><b style="white-space:nowrap" >Tempo totale di inattività : </b> <span style="white-space:nowrap" id="totInactive"></span></li>
			<li><b style="white-space:nowrap" >Tempo dall'ultimo evento di <span id="lastEventType"></span> : </b> <span style="white-space:nowrap" id="lastEventElapsed"></span></li>
		<ul>
		<br/>
		-->
		<br/>
		<div id="chart_div" style="width: 560px; height: 300px;display:inline-block;"></div>
		<div id="piechart" style="width: 400px; height: 300px;display:inline-block;"></div>
		<br/>
		<table>
			<thead>
				<th colspan="5" style="background-color: transparent; border:0; margin:0; padding:0;">
					<input type="text" id="filtraMovimenti" onkeyup="filtraMovimenti()" placeholder="Cerca nella tabella dei movimenti..."/>
				</th>
			</thead>
			<thead>
				<th>Data</th>
				<th>Descrizione</th>
				<th>Tipo operazione</th>
				<th>Importo</th>
				<th>Utente</th>
			</thead>
			<tbody id="listMovimenti">
				<td></td><td></td><td></td><td></td><td></td>
			</tbody>
		</table>
	</div>
	<br/><br/>
	<div id="displaydataRimborsi" style="display:none">
		<b>Lista Rimborsi</b><br/>
		<table>
			<thead>
				<th>Data</th>
				<th>Descrizione</th>
				<th>Importo</th>
				<th>Dare/Avere</th>
			</thead>
			<tbody id="listRimborsi">
				<td></td><td></td><td></td><td></td>
			</tbody>
		</table>
	</div>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script>
		$(document).ready(function(){		
			refreshMovimenti();
			refreshRimborsi();
		});
		function refreshMovimenti(){
			$.get("/api/movimenti").then(function(data){
				var users = [];
				$("#listMovimenti").html("");
				var totActive = 0;
				var totInactive = 0;
				var i = 0;
				for(i = 0; i < data.length ; i++){
					var $tr = $("<tr/>");
					var $td = $("<td style='white-space:nowrap'/>");
					$td.text(data[i].data);
					$tr.append($td);
					$td = $("<td/>");
					$td.text(data[i].descrizione);
					$tr.append($td);
					$td = $("<td/>");
					$td.text(data[i].tipoOperazione);
					$tr.append($td);
					$td = $("<td/>");
					$td.text(formatImporto(data[i].importo));
					$tr.append($td);
					$td = $("<td/>");
					$td.text(data[i].utente.nome);
					$tr.append($td);
					$("#listMovimenti").append($tr);
					//Conti
					if(!users[data[i].idUtente]) users[data[i].idUtente] = data[i].utente;
					users[data[i].idUtente].totaleUscite = (users[data[i].idUtente].totaleUscite || 0) + data[i].importo;
				}
				$("#displaydataMovimenti").show();
				try{drawChart(users);}catch(e){}
				try{drawVisualization(data);}catch(e){}
			});
		}
		function refreshRimborsi(){
			$.get("/api/rimborsi").then(function(data){
				var users = [];
				$("#listRimborsi").html("");
				var i = 0;
				for(i = 0; i < data.length ; i++){
					var $tr = $("<tr/>");
					var $td = $("<td style='white-space:nowrap'/>");
					$td.text(data[i].data);
					$tr.append($td);
					$td = $("<td/>");
					$td.text(data[i].descrizione);
					$tr.append($td);
					$td = $("<td/>");
					$td.text(formatImporto(data[i].importo));
					$tr.append($td);
					$td = $("<td/>");
					$td.text(data[i].utenteBeneficiario.nome + " deve rendere a " + data[i].utenteOrdinante.nome);
					$tr.append($td);
					$("#listRimborsi").append($tr);
				}
				$("#displaydataRimborsi").show();
			});
		}
		function utcToLocalDateTime(date){
			var d = new Date(date);
			mm = '' + (d.getMonth() + 1),
			dd = '' + d.getDate(),
			yyyy = d.getFullYear();
			hh24 = '' + d.getHours();
			mi = '' + d.getMinutes();
			ss = '' + d.getSeconds();
			if (mm.length < 2) mm = '0' + mm;
			if (dd.length < 2) dd = '0' + dd;
			if (hh24.length < 2) hh24 = '0' + hh24;
			if (mi.length < 2) mi = '0' + mi;
			if (ss.length < 2) ss = '0' + ss;
			return [dd,mm,yyyy].join('/') + " " + [hh24,mi,ss].join(':');
		}
		function utcToLocalTime(date){
			var d = new Date(date);
			mm = '' + (d.getMonth() + 1),
			dd = '' + d.getDate(),
			yyyy = d.getFullYear();
			hh24 = '' + d.getHours();
			mi = '' + d.getMinutes();
			ss = '' + d.getSeconds();
			if (mm.length < 2) mm = '0' + mm;
			if (dd.length < 2) dd = '0' + dd;
			if (hh24.length < 2) hh24 = '0' + hh24;
			if (mi.length < 2) mi = '0' + mi;
			if (ss.length < 2) ss = '0' + ss;
			return [hh24,mi,ss].join(':');
		}
		function utcToLocalDate(date){
			var d = new Date(date);
			mm = '' + (d.getMonth() + 1),
			dd = '' + d.getDate(),
			yyyy = d.getFullYear();
			hh24 = '' + d.getHours();
			mi = '' + d.getMinutes();
			ss = '' + d.getSeconds();
			if (mm.length < 2) mm = '0' + mm;
			if (dd.length < 2) dd = '0' + dd;
			if (hh24.length < 2) hh24 = '0' + hh24;
			if (mi.length < 2) mi = '0' + mi;
			if (ss.length < 2) ss = '0' + ss;
			return [dd,mm,yyyy].join('/');
		}
		function elapsedToHHMMSS(elapsed){
			var d = new Date(elapsed);
			hh24 = '' + (d.getHours()-1);
			mi = '' + d.getMinutes();
			ss = '' + d.getSeconds();
			if (hh24.length < 2) hh24 = '0' + hh24;
			if (mi.length < 2) mi = '0' + mi;
			if (ss.length < 2) ss = '0' + ss;
			return [hh24,mi,ss].join(':');
		}
		function notify(message) {
		  if (Notification.permission !== "granted")
			Notification.requestPermission().then(function(){notify(message)});
		  else {
			var notification = new Notification('Controllo timbrature', {
			  icon: 'https://cdn.iconscout.com/icon/free/png-64/clock-1960-1119646.png',
			  body: message
			});

			notification.onclick = function () {};

		  }

		}
		function formatImporto(v){return v ? (""+v.toFixed(2)).replace(".",",")+" €" : "0,00 €"}
	</script>
	<script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(()=>{
		refreshMovimenti();
	  });

      function drawChart(users) {
		if(!users) return;
	    var datiGrafico = [['Utente', 'Spesa']];
		datiGrafico = datiGrafico.concat(users.map(e=>{return [e.nome,e.totaleUscite];}));
		datiGrafico = datiGrafico.filter(Boolean);
        var data = google.visualization.arrayToDataTable(datiGrafico);

        var options = {
          title: 'Ripartizione totale spese',
		  colors: ['#FF6600','#7030A0']
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart'));

        chart.draw(data, options);
      }
	  function drawVisualization(movimenti) {
        // Some raw data (not necessarily accurate)
        var datiGrafico = [['Month','Totale'],['Gennaio'],['Febbraio'],['Marzo'	],['Aprile'	],['Maggio'	],['Giugno'	],['Luglio'	],['Agosto'	],['Settembre'],['Ottobre'],['Novembre'],['Dicembre']];
		var datiUtenti = [];
		var utenti = [];
		//Scorro i movimenti
		for(var i = 0; i<movimenti.length; i++){
			var j = parseInt(movimenti[i].data.substring(3,5));
			datiGrafico[j][1] = (datiGrafico[j][1] || 0) + movimenti[i].importo;			
			var k = utenti[movimenti[i].idUtente] || 1+utenti.filter(Boolean).length;
			utenti[movimenti[i].idUtente] = k;
			datiGrafico[j][k+1] = (datiGrafico[j][k+1]||0) + movimenti[i].importo; 
			datiGrafico[0][k+1] = movimenti[i].utente.nome;
		}
		
		datiGrafico = datiGrafico.map(e=>{
			for(var i = 1 ; i <= utenti.filter(Boolean).length +1 ; i++){
				e[i] = e[i] || 0;
			}
			return e
		});
		
		var data = google.visualization.arrayToDataTable(datiGrafico);

        var options = {
          title : 'Ripartizione mensile spese',
          vAxis: {title: 'Euro'},
          hAxis: {title: 'Mesi'},
          seriesType: 'bars',
          series: {0: {type: 'line'}},
		  colors: ['#3399FF','#FF6600','#7030A0']
        };

        var chart = new google.visualization.ComboChart(document.getElementById('chart_div'));
        chart.draw(data, options);
      }
	  function filtraMovimenti() {
		  var input, filter, table, tr, td, i, j, txtValue;
		  input = document.getElementById("filtraMovimenti");
		  filter = input.value.toUpperCase();
		  table = document.getElementById("listMovimenti");
		  tr = table.getElementsByTagName("tr");
		  for (i = 0; i < tr.length; i++) {
			td = tr[i].getElementsByTagName("td");
			for (j = 0; j < td.length; j++){
				if (td[j]) {
				  txtValue = td[j].textContent || td[j].innerText;
				  if (txtValue.toUpperCase().indexOf(filter) > -1) {
					tr[i].style.display = "";
					break;
				  } else {
					tr[i].style.display = "none";
				  }
				}
			}
		  }
		}
    </script>
  </body>
</html>
